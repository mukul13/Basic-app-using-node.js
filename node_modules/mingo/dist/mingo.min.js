!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(n.Mingo=n.Mingo||{})}(this,function(n){"use strict";function t(){return{isArray:s,isBoolean:o,isDate:h,isEmpty:x,isEqual:q,isFunction:p,isNil:d,isNull:g,isNumber:l,isObject:c,isObjectLike:f,isRegExp:v,isString:a,isUndefined:$}}function r(n,t){_(n)&&N(t)}function e(n){return r(!$(n))}function u(n){switch(w(n)){case"array":return n.map(u);case"object":return A(n,u);default:return n}}function i(n,t){return w(n)===t}function o(n){return i(n,"boolean")}function a(n){return i(n,"string")}function l(n){return i(n,"number")}function s(n){return i(n,"array")}function c(n){return i(n,"object")}function f(n){return n===Object(n)}function h(n){return i(n,"date")}function v(n,t){return i(n,"regexp")}function p(n,t){return i(n,"function")}function d(n){return g(n)||$(n)}function g(n){return i(n,"null")}function $(n){return i(n,"undefined")}function m(n,t){return n.includes(t)}function y(n,t){return!n.includes(t)}function b(n){return!!n}function _(n){return!n}function x(n){return d(n)||s(n)&&0===n.length||c(n)&&0===M(n).length||!n}function O(n){return s(n)?n:[n]}function w(n){return an.toString.call(n).match(/\s(\w+)/)[1].toLowerCase()}function j(n,t){return an.hasOwnProperty.call(n,t)}function N(n){throw new Error(n)}function M(n){return Object.keys(n)}function k(n,t,e){if(r(n===Object(n),"Cannot iterate over object of type '"+w(n)+"'"),s(n))for(var u=0,i=n.length;i>u;u++)t.call(e,n[u],u);else for(var o in n)j(n,o)&&t.call(e,n[o],o)}function A(n,t,r){if(s(n))return n.map(t,r);if(c(n)){for(var e,u={},i=M(n),o=0,a=i.length;a>o;o++)e=i[o],u[e]=t.call(r,n[e],e);return u}N("Input must be an Array or Object type")}function E(n,t){return n.filter(m.bind(null,t))}function I(n,t){var r=[];return F(r,n),F(r,t.filter(y.bind(null,n))),r}function q(n,t){if(n===t)return!0;var r=w(n);if(r!==w(t))return!1;if("number"===r&&isNaN(n)&&isNaN(t))return!0;if(m(["date","regexp"],r))return n.toString()===t.toString();var e,u;if("array"===r){if(n.length===t.length&&0===n.length)return!0;if(n.length!==t.length)return!1;for(e=0,u=n.length;u>e;e++)if(!q(n[e],t[e]))return!1}else{if(![n,t].every(c))return!1;var i=M(n),o=M(t);if(i.length!==o.length)return!1;if(i.sort(),o.sort(),!q(i,o))return!1;for(e=0,u=i.length;u>e;e++){var a=i[e];if(!q(n[a],t[a]))return!1}}return!0}function C(n){var t={},r=[];return k(n,function(n){var e=P(n);j(t,e)||(r.push(n),t[e]=0)}),r}function S(n){return JSON.stringify({"":n})+w(n)+n}function P(n){var t,r,e,u=0,i=S(n);if(0===i.length)return u;for(t=0,e=i.length;e>t;t++)r=i.charCodeAt(t),u=(u<<5)-u+r,u|=0;return u.toString()}function T(n,t,e){for(var u={},i=[],o=n.length,a=[],l=0;o>l;l++){var s=n[l],c=t.call(e,s,l);if(d(c))a.push(s);else{var f=P(s);j(u,f)||(u[f]=[c,l]),i.push(s)}}return i.sort(function(n,t){var r=u[P(n)],e=u[P(t)];return r[0]<e[0]?-1:r[0]>e[0]?1:r[1]<e[1]?-1:r[1]>e[1]?1:0}),F(a,i),r(a.length===n.length,"sortBy must retain collection length"),a}function D(n,t,e){var u={keys:[],groups:[]},i={};return k(n,function(n){var r=t.call(e,n),o=P(r),a=-1;$(i[o])&&(a=u.keys.length,i[o]=a,u.keys.push(r),u.groups.push([])),a=i[o],u.groups[a].push(n)}),r(u.keys.length===u.groups.length,"Cardinality must be equal for groups and keys"),u}function F(n,t){on.push.apply(n,t)}function Q(n){var t=n.dataset.reduce(function(n,t){return n+t},0),r=n.dataset.length||1,e=n.sampled===!0?1:0,u=t/(r-e);return Math.sqrt(n.dataset.reduce(function(n,t){return n+Math.pow(t-u,2)},0)/r)}function R(n,t){for(var r=0,e=n.length-1;e>=r;){var u=Math.round(r+(e-r)/2);if(t<n[u])e=u-1;else{if(!(t>n[u]))return u;r=u+1}}return r}function L(n){return function(t){return function(){var r=on.slice.call(arguments),e=P(r);return j(t,e)||(t[e]=n.apply(this,r)),t[e]}}({})}function U(){return sn.key}function B(n,t){return n[t]}function Y(n,t){return j(n,"__mingo__")&&c(t)&&q(Object.assign({},n.__mingo__,t),n.__mingo__)}function J(n,t,r){for(var e=t.split("."),u=n,i=0;i<e.length;i++){var o=null===e[i].match(/^\d+$/);if(o&&s(u)){if(r===!0&&0===i)return u;u=u.map(function(n){return J(n,e[i],!0)}),u.__mingo__={isMulti:!0},1===u.length&&(u=u[0])}else u=B(u,e[i]),r=!1;if(d(u))break}return u}function z(n,t){if(!d(n)){var u,i,o=t.split("."),a=o[0],l=1===o.length||o.slice(1).join("."),c=null!==a.match(/^\d+$/),f=o.length>1;try{s(n)?c?(u=B(n,a),f&&(u=z(u,l)),e(u),u=[u]):(u=[],k(n,function(n){i=z(n,t),d(i)||u.push(i)}),r(u.length>0)):(i=B(n,a),f&&(i=z(i,l)),e(i),u={},u[a]=i)}catch(h){u=void 0}return u}}function G(n,t,r,e){var u=t.split("."),i=u[0],o=1===u.length||u.slice(1).join(".");if(1===u.length)r(n,i);else if(s(n)&&!/^\d+$/.test(i))k(n,function(n){G(n,t,r,e)});else{if(e===!0){var a=j(n,i);a&&!d(n[i])||(n[i]={})}G(n[i],o,r,e)}}function H(n,t,r){G(n,t,function(n,t){n[t]=r},!0)}function V(n,t){G(n,t,function(n,t){s(n)&&/^\d+$/.test(t)?n.splice(parseInt(t),1):c(n)&&delete n[t]})}function W(n){for(var t=0;t<pn.length;t++)if(pn[t](n))return!0;return!1}function K(n){return W(n)||!f(n)}function X(n){if(K(n))return v(n)?{$regex:n}:{$eq:n};if(f(n)){var t=M(n),r=0===E(un(qn),t).length;if(r)return{$eq:n};if(m(t,"$regex")){var e=n.$regex,u=n.$options||"",i="";a(e)&&(i+=e.ignoreCase||u.indexOf("i")>=0?"i":"",i+=e.multiline||u.indexOf("m")>=0?"m":"",i+=e.global||u.indexOf("g")>=0?"g":"",e=new RegExp(e,i)),n.$regex=e,delete n.$options}}return n}function Z(n,t,e,u){if(u=u||{},u.root=u.root||n,m(un(Sn),e))return In[e](n,t,u);if(m(un(Cn),e))return n=Z(n,t,null,u),r(s(n),e+" expression must resolve to an array"),dn[e](n,null,u);if(a(t)&&t.length>0&&"$"===t[0]){if(m(hn,t))return cn[t](n,null,u);if(m(vn,t))return t;var i=hn.filter(function(n){return 0===t.indexOf(n+".")});return 1===i.length&&(i=i[0],"$$ROOT"===i&&(n=u.root),t=t.substr(i.length)),J(n,t.slice(1))}switch(w(t)){case"array":return t.map(function(t){return Z(n,t,null)});case"object":var o={};for(var l in t)if(j(t,l)&&(o[l]=Z(n,t[l],l,u),m(un(Sn),l))){r(1===M(t).length,"Invalid aggregation expression '"+ln(t)+"'"),o=o[l];break}return o;default:return t}}function nn(n,t,e){return d(e)?0>t?(t=Math.max(0,n.length+t),e=n.length-t+1):(e=t,t=0):(0>t&&(t=Math.max(0,n.length+t)),r(e>0,"Invalid argument value for $slice operator. Limit must be a positive number"),e+=t),on.slice.apply(n,[t,e])}function Q(n){var t=n.dataset.reduce(function(n,t){return n+t},0),r=n.dataset.length||1,e=n.sampled===!0?1:0,u=t/(r-e);return Math.sqrt(n.dataset.reduce(function(n,t){return n+Math.pow(t-u,2)},0)/r)}function tn(n,t,r){r=r||{},r.root=r.root||n;var e=Z(n,t,null,r);return m(vn,e)?fn[e](n,t,r):e}function rn(n,t,r){if(m(un(Cn),t))return dn[t](n,r);if(c(r)){var e={};for(var u in r)if(j(r,u)&&(e[u]=rn(n,u,r[u]),m(un(Cn),u))){e=e[u],M(r).length>1&&N("Invalid $group expression '"+ln(r)+"'");break}return e}}function en(n,t){return new Array(Math.max(t-String(n).length+1,0)).join("0")+n}function un(n){return M(Dn[n])}n.VERSION="1.2.0";var on=Array.prototype,an=Object.prototype,ln=JSON.stringify;Function.prototype.bind||(Function.prototype.bind=function(n){if("function"!=typeof this)throw new Error("Function.prototype.bind - what is trying to be bound is not callable");var t=on.slice.call(arguments,1),r=this,e=function(){},u=function(){return r.apply(this instanceof e?this:n,t.concat(on.slice.call(arguments)))};return this.prototype&&(e.prototype=this.prototype),u.prototype=new e,u}),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(n){if(null==this)throw new TypeError('"this" is null or not defined');var t=Object(this),r=t.length>>>0;if("function"!=typeof n)throw new TypeError("predicate must be a function");for(var e=arguments[1],u=0;r>u;){var i=t[u];if(n.call(e,i,u,t))return i;u++}}}),Array.prototype.findIndex||Object.defineProperty(Array.prototype,"findIndex",{value:function(n){if(null==this)throw new TypeError('"this" is null or not defined');var t=Object(this),r=t.length>>>0;if("function"!=typeof n)throw new TypeError("predicate must be a function");for(var e=arguments[1],u=0;r>u;){var i=t[u];if(n.call(e,i,u,t))return u;u++}return-1}}),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(n,t){function r(n,t){return n===t||"number"==typeof n&&"number"==typeof t&&isNaN(n)&&isNaN(t)}if(null==this)throw new TypeError('"this" is null or not defined');var e=Object(this),u=e.length>>>0;if(0===u)return!1;for(var i=0|t,o=Math.max(i>=0?i:u-Math.abs(i),0);u>o;){if(r(e[o],n))return!0;o++}return!1}}),"function"!=typeof Object.assign&&(Object.assign=function(n,t){if(null==n)throw new TypeError("Cannot convert undefined or null to object");for(var r=Object(n),e=on.slice.call(arguments),u=1;u<e.length;u++){var i=e[u];if(null!=i)for(var o in i)an.hasOwnProperty.call(i,o)&&(r[o]=i[o])}return r}),Object.keys||(Object.keys=function(n){if(n!==Object(n))throw new TypeError("Object.keys called on a non-object");var t=[];for(var r in n)an.hasOwnProperty.call(n,r)&&t.push(r);return t}),Object.values||(Object.values=function(n){if(n!==Object(n))throw new TypeError("Object.values called on a non-object");var t=[];for(var r in n)an.hasOwnProperty.call(n,r)&&t.push(n[r]);return t});var sn={key:"_id"};n.setup=function(n){Object.assign(sn,n||{})},n._internal=function(){return Object.assign(t(),{computeValue:Z})};var cn={$$ROOT:function(n,t,r){return r.root},$$CURRENT:function(n){return n}},fn={$$KEEP:function(n){return n},$$PRUNE:function(){},$$DESCEND:function(n,t,r){if(!j(t,"$cond"))return n;var e;return k(n,function(u,i){f(u)&&(s(u)?(e=[],k(u,function(n){c(n)&&(n=tn(n,t,r)),d(n)||e.push(n)})):e=tn(u,t,r),d(e)?delete n[i]:n[i]=e)}),n}},hn=M(cn),vn=M(fn),pn=[a,o,l,h,d,v];n.Aggregator=function(t){return this instanceof n.Aggregator?void(this.__operators=t):new n.Aggregator(t)},n.Aggregator.prototype.run=function(t,r){if(!x(this.__operators))for(var e=0;e<this.__operators.length;e++){var u=this.__operators[e],i=M(u);1===i.length&&m(un(Pn),i[0])?(i=i[0],t=r instanceof n.Query?gn[i].call(r,t,u[i]):gn[i](t,u[i])):N("Invalid aggregation operator '"+i+"'")}return t},n.Cursor=function(t,r,e){return this instanceof n.Cursor?(this.__query=r,this.__collection=t,this.__projection=e||r.__projection,this.__operators={},this.__result=!1,void(this.__position=0)):new n.Cursor(t,r,e)},n.Cursor.prototype={_fetch:function(){var t=this;if(this.__result!==!1)return this.__result;c(this.__projection)&&Object.assign(this.__operators,{$project:this.__projection}),s(this.__collection)||N("Input collection is not of valid type. Must be an Array."),this.__result=this.__collection.filter(this.__query.test,this.__query);var r=[];if(k(["$sort","$skip","$limit","$project"],function(n){if(j(t.__operators,n)){var e={};e[n]=t.__operators[n],r.push(e)}}),r.length>0){var e=new n.Aggregator(r);this.__result=e.run(this.__result,this.__query)}return this.__result},all:function(){return this._fetch()},first:function(){return this.count()>0?this._fetch()[0]:null},last:function(){return this.count()>0?this._fetch()[this.count()-1]:null},count:function(){return this._fetch().length},skip:function(n){return Object.assign(this.__operators,{$skip:n}),this},limit:function(n){return Object.assign(this.__operators,{$limit:n}),this},sort:function(n){return Object.assign(this.__operators,{$sort:n}),this},next:function(){return this.hasNext()?this._fetch()[this.__position++]:null},hasNext:function(){return this.count()>this.__position},max:function(n){return dn.$max(this._fetch(),n)},min:function(n){return dn.$min(this._fetch(),n)},map:function(n){return A(this._fetch(),n)},forEach:function(n){k(this._fetch(),n)}},"function"==typeof Symbol&&Symbol.iterator&&(n.Cursor.prototype[Symbol.iterator]=function(){var n=this;return{next:function(){return n.hasNext()?{done:!1,value:n.next()}:{done:!0}}}}),n.Query=function(t,r){return this instanceof n.Query?(this.__criteria=t,this.__projection=r,this.__compiled=[],void this._compile()):new n.Query(t,r)},n.Query.prototype={_compile:function(){if(!x(this.__criteria)){r(c(this.__criteria),"Criteria must be of type Object");var n;for(var t in this.__criteria){if(j(this.__criteria,t)){var e=this.__criteria[t];if("$where"===t)n={field:t,expr:e};else if(m(["$and","$or","$nor"],t))this._processOperator(t,t,e);else{e=X(e);for(var u in e)j(e,u)&&this._processOperator(t,u,e[u])}}c(n)&&this._processOperator(n.field,n.field,n.expr)}}},_processOperator:function(n,t,r){m(un(qn),t)?this.__compiled.push(yn[t](n,r)):N("Invalid query operator '"+t+"' detected")},test:function(n){for(var t=0;t<this.__compiled.length;t++)if(!this.__compiled[t].test(n))return!1;return!0},find:function(t,r){return new n.Cursor(t,this,r)},remove:function(n){var t=this;return n.reduce(function(n,r){return t.test(r)||n.push(r),n},[])}};var dn={$addToSet:function(n,t){return C(this.$push(n,t))},$sum:function(n,t){return s(n)?l(t)?n.length*t:this.$push(n,t).filter(l).reduce(function(n,t){return n+t},0):0},$max:function(n,t){var r=this.$push(n,t);return r.reduce(function(n,t){return d(n)||t>n?t:n},void 0)},$min:function(n,t){var r=this.$push(n,t);return r.reduce(function(n,t){return d(n)||n>t?t:n},void 0)},$avg:function(n,t){var r=this.$push(n,t).filter(l),e=r.reduce(function(n,t){return n+t},0);return e/(r.length||1)},$push:function(n,t){return d(t)?n:n.map(function(n){return Z(n,t,null)})},$first:function(n,t){return n.length>0?Z(n[0],t):void 0},$last:function(n,t){return n.length>0?Z(n[n.length-1],t):void 0},$stdDevPop:function(n,t){var r=this.$push(n,t).filter(l);return Q({dataset:r,sampled:!1})},$stdDevSamp:function(n,t){var r=this.$push(n,t).filter(l);return Q({dataset:r,sampled:!0})}},gn={$addFields:function(n,t){var e=M(t);return n.map(function(n){return n=u(n),k(e,function(e){var u,i=t[e];if(c(i)){var o=M(i),a=o.filter(function(n){return 0===n.indexOf("$")});x(a)||(r(1===o.length,"Can have only one root operator in $addFields"),a=a[0],i=i[a],u=Z(n,i,a))}else u=Z(n,i,null);G(n,e,function(n,t){n[t]=u},!0)}),n})},$group:function(n,t){var r=t[U()],e=D(n,function(n){return Z(n,r,r)}),u=[];return delete t[U()],k(e.keys,function(n,r){var i={};$(n)||(i[U()]=n);for(var o in t)j(t,o)&&(i[o]=rn(e.groups[r],o,t[o]));u.push(i)}),u},$lookup:function(n,t){function e(n){return P(d(n)?null:n)}var i=t.from,o=t.localField,l=t.foreignField,c=t.as,f="Invalid $lookup expression. ";r(s(i),f+"'from' must be an array"),r(a(l),f+"'foreignField' must be a string"),r(a(o),f+"'localField' must be a string"),r(a(c),f+"'as' must be a string");var h=[],v={};if(i.length<=n.length)k(i,function(n,t){var r=e(n[l]);v[r]=v[r]||[],v[r].push(t)}),k(n,function(n){var t=e(n[o]),r=v[t]||[],a=u(n);a[c]=A(r,function(n){return u(i[n])}),h.push(a)});else{k(n,function(n,t){var r=e(n[o]);v[r]=v[r]||[],v[r].push(t)});var p={};k(i,function(t){var r=e(t[l]),i=v[r]||[];k(i,function(r){var e=p[r]||u(n[r]);e[c]=e[c]||[],e[c].push(u(t)),p[r]=e})});for(var g=0,$=M(p).length;$>g;g++)h.push(p[g])}return h},$match:function(t,r){return new n.Query(r).find(t).all()},$project:function(n,t){if(x(t))return n;var e=[],i=M(t),o=!1,s=[!1,!1];if(k(i,function(n){var e=t[n];n!==U()&&(0===e||e===!1?s[0]=!0:s[1]=!0,r(s[0]!==s[1],"Projection cannot have a mix of inclusion and exclusion."))}),m(i,U())){var f=t[U()];0!==f&&f!==!1||(i=i.filter(y.bind(null,[U()])),r(y(i,U()),"Must not contain collections _id"),o=x(i))}else i.push(U());return k(n,function(n,r){var s={},f=!1,h=!1,v=[];o&&v.push(U()),k(i,function(r){var e,i,o=t[r];if(r!==U()&&0===o&&(h=!0),r===U()&&x(o))e=n[r];else if(a(o))e=Z(n,o,r);else if(1===o||o===!0);else{if(!c(o))return void v.push(r);var p=M(o);p=p.length>1?!1:p[0],m(un(Tn),p)?"$slice"===p?O(o[p]).every(l)?(e=$n[p](n,o[p],r),f=!0):e=Z(n,o,r):e=$n[p](n,o[p],r):e=Z(n,o,r)}i=u(z(n,r)),$(i)||Object.assign(s,i),$(e)||H(s,r,u(e))}),(f||h||o)&&(s=Object.assign(u(n),s),k(v,function(n){V(s,n)})),e.push(s)}),e},$limit:function(n,t){return n.slice(0,t)},$skip:function(n,t){return n.slice(t)},$unwind:function(n,t){for(var r=[],e=t.substr(1),i=0;i<n.length;i++){var o=n[i],a=B(o,e);s(a)?k(a,function(n){var t=u(o);t[e]=n,r.push(t)}):N("Target field '"+e+"' is not of type Array.")}return r},$sort:function(n,t){if(!x(t)&&c(t)){var r=M(t);k(r.reverse(),function(r){var e=D(n,function(n){return J(n,r)}),u={},i=function(n){return u[P(n)]},o=T(e.keys,function(n,t){return u[P(n)]=t,n});-1===t[r]&&o.reverse(),n=[],k(o,function(t){F(n,e.groups[i(t)])})})}return n},$sortByCount:function(n,t){var r={count:{$sum:1}};return r[U()]=t,this.$sort(this.$group(n,r),{count:-1})},$sample:function(n,t){var e=t.size;r(l(e),"$sample size must be a positive integer");for(var u=[],i=0;e>i;i++){var o=Math.floor(Math.random()*n.length);u.push(n[o])}return u},$count:function(n,t){r(a(t)&&""!==t.trim()&&-1===t.indexOf(".")&&"$"!==t.trim()[0],"Invalid expression value for $count");var e={};return e[t]=n.length,e},$replaceRoot:function(n,t){var e=t.newRoot,u=[];return k(n,function(n){n=Z(n,e,null),r(c(n),"$replaceRoot expression must return a valid JS object"),u.push(n)}),u},$redact:function(n,t){return n.map(function(n){return tn(u(n),t)})},$bucket:function(n,t){var e=t.boundaries,u=t["default"],i=e[0],o=e[e.length-1],a=t.output||{count:{$sum:1}};r(e.length>2,"$bucket 'boundaries' expression must have at least 3 elements");for(var l=w(i),s=0,c=e.length-1;c>s;s++)r(l===w(e[s+1]),"$bucket 'boundaries' must all be of the same type"),r(e[s]<e[s+1],"$bucket 'boundaries' must be sorted in ascending order");d(u)||w(t["default"])!==w(i)||r(i>t["default"]||o<t["default"],"$bucket 'default' expression must be out of boundaries range");var f={};return k(e,function(n){f[n]=[]}),d(u)||(f[u]=[]),k(n,function(n){var a=Z(n,t.groupBy,null);if(d(a)||i>a||a>=o)r(!d(u),"$bucket require a default for out of range values"),f[u].push(n);else if(a>=i&&o>a){var l=R(e,a),s=e[Math.max(0,l-1)];f[s].push(n)}else N("$bucket 'groupBy' expression must resolve to a value in range of boundaries")}),e.pop(),d(u)||e.push(u),A(e,function(n){var t=rn(f[n],null,a);return Object.assign(t,{_id:n})})},$bucketAuto:function(n,t){var e=t.output||{count:{$sum:1}},u=t.groupBy,i=(t.granularity,t.buckets);r(i>0,"The $bucketAuto 'buckets' field must be greater than 0, but found: "+i);var o=Math.round(n.length/i);1>o&&(o=1);for(var a=L(Z),l={},s=[],c=T(n,function(n){var t=a(n,u,null);return d(t)?s.push(n):(l[t]||(l[t]=[]),l[t].push(n)),t}),f=[],h=0,v=c.length,p=0;i>p&&v>h;p++){for(var g={},$=[],m=0;o>m&&v>h;m++){var y=a(c[h],u,null);if(d(y)&&(y=null),F($,d(y)?s:l[y]),h+=d(y)?s.length:l[y].length,j(g,"min")||(g.min=y),f.length>0){var b=f[f.length-1];b._id.max=g.min}}p==i-1&&F($,c.slice(h)),f.push(Object.assign(rn($,null,e),{_id:g}))}return f.length>0&&(f[f.length-1]._id.max=a(c[c.length-1],u,null)),f},$facet:function(t,r){return A(r,function(r){return n.aggregate(t,r)})}},$n={$:function(n,t,r){N("$ not implemented")},$elemMatch:function(t,r,e){var u=J(t,e),i=new n.Query(r);if(!d(u)&&s(u))for(var o=0;o<u.length;o++)if(i.test(u[o]))return[u[o]]},$slice:function(n,t,r){var e=J(n,r);return s(e)?s(t)?nn(e,t[0],t[1]):l(t)?nn(e,t):void N("Invalid argument type for $slice projection operator"):e},$stdDevPop:function(n,t,r){var e=Z(n,t,r);return Q({dataset:e,sampled:!1})},$stdDevSamp:function(n,t,r){var e=Z(n,t,r);return Q({dataset:e,sampled:!0})}},mn={$eq:function(n,t){if(q(n,t))return!0;if(s(n)){if(!Y(n,{isMulti:!0}))return-1!==n.findIndex(q.bind(null,t));for(var r=0;r<n.length;r++)if(this.$eq(n[r],t))return!0}return!1},$ne:function(n,t){return!this.$eq(n,t)},$in:function(n,t){return n=O(n),E(n,t).length>0},$nin:function(n,t){return d(n)||!this.$in(n,t)},$lt:function(n,t){return n=O(n).find(function(n){return t>n}),void 0!==n},$lte:function(n,t){return n=O(n).find(function(n){return t>=n}),void 0!==n},$gt:function(n,t){return n=O(n).find(function(n){return n>t}),void 0!==n},$gte:function(n,t){return n=O(n).find(function(n){return n>=t}),void 0!==n},$mod:function(n,t){return n=O(n).find(function(n){return l(n)&&s(t)&&2===t.length&&n%t[0]===t[1]}),void 0!==n},$regex:function(n,t){return n=O(n).find(function(n){return a(n)&&v(t)&&!!n.match(t)}),void 0!==n},$exists:function(n,t){return(t===!1||0===t)&&d(n)||(t===!0||1===t)&&!d(n)},$all:function(n,t){var r=this,e=!1;if(s(n)&&s(t))for(var u=0;u<t.length;u++){if(!c(t[u])||!m(M(t[u]),"$elemMatch"))return E(t,n).length===t.length;e=e||r.$elemMatch(n,t[u].$elemMatch)}return e},$size:function(n,t){return s(n)&&l(t)&&n.length===t},$elemMatch:function(t,r){if(s(t)&&!x(t))for(var e=new n.Query(r),u=0;u<t.length;u++)if(e.test(t[u]))return!0;return!1},$type:function(n,t){switch(t){case 1:case"double":return l(n)&&-1!==(n+"").indexOf(".");case 2:case"string":case 5:case"bindata":return a(n);case 3:case"object":return c(n);case 4:case"array":return s(n);case 6:case"undefined":return d(n);case 8:case"bool":return o(n);case 9:case"date":return h(n);case 10:case"null":return g(n);case 11:case"regex":return v(n);case 16:case"int":return l(n)&&2147483647>=n&&-1===(n+"").indexOf(".");case 18:case"long":return l(n)&&n>2147483647&&0x8000000000000000>=n&&-1===(n+"").indexOf(".");case 19:case"decimal":return l(n);default:return!1}}},yn={$and:function(t,e){r(s(e),"Invalid expression: $and expects value to be an Array");var u=[];return k(e,function(t){u.push(new n.Query(t))}),{test:function(n){for(var t=0;t<u.length;t++)if(!u[t].test(n))return!1;return!0}}},$or:function(t,r){s(r)||N("Invalid expression for $or criteria");var e=[];return k(r,function(t){e.push(new n.Query(t))}),{test:function(n){for(var t=0;t<e.length;t++)if(e[t].test(n))return!0;return!1}}},$nor:function(n,t){s(t)||N("Invalid expression for $nor criteria");var r=this.$or("$or",t);return{test:function(n){return!r.test(n)}}},$not:function(t,r){var e={};e[t]=X(r);var u=new n.Query(e);return{test:function(n){return!u.test(n)}}},$where:function(n,t){return p(t)||(t=new Function("return "+t+";")),{test:function(n){return t.call(n)===!0}}}};k(mn,function(n,t){yn[t]=function(n,t){return function(r,e){return{test:function(u){var i=J(u,r);return n.call(t,i,e)}}}}(n,mn)});var bn={$abs:function(n,t){var r=Z(n,t,null);return null===r||void 0===r?null:Math.abs(r)},$add:function(n,t){var r=Z(n,t,null);return r.reduce(function(n,t){return n+t},0)},$ceil:function(n,t){var e=Z(n,t,null);return isNaN(e)?NaN:d(e)?null:(r(l(e),"$ceil must be a valid expression that resolves to a number."),Math.ceil(e))},$divide:function(n,t){var r=Z(n,t,null);return r[0]/r[1]},$exp:function(n,t){var e=Z(n,t,null);return isNaN(e)?NaN:d(e)?null:(r(l(e),"$exp must be a valid expression that resolves to a number."),Math.exp(e))},$floor:function(n,t){var e=Z(n,t,null);return isNaN(e)?NaN:d(e)?null:(r(l(e),"$floor must be a valid expression that resolves to a number."),Math.floor(e))},$ln:function(n,t){var e=Z(n,t,null);return isNaN(e)?NaN:d(e)?null:(r(l(e),"$ln must be a valid expression that resolves to a number."),Math.log(e))},$log:function(n,t){var e=Z(n,t,null);return r(s(e)&&2===e.length,"$log must be a valid expression that resolves to an array of 2 items"),e.some(isNaN)?NaN:e.some(d)?null:(r(e.every(l),"$log expression must resolve to array of 2 numbers"),Math.log10(e[0])/Math.log10(e[1]))},$log10:function(n,t){var e=Z(n,t,null);return isNaN(e)?NaN:d(e)?null:(r(l(e),"$log10 must be a valid expression that resolves to a number."),Math.log10(e))},$mod:function(n,t){var r=Z(n,t,null);return r[0]%r[1]},$multiply:function(n,t){var r=Z(n,t,null);return r.reduce(function(n,t){return n*t},1)},$pow:function(n,t){var e=Z(n,t,null);return r(s(e)&&2===e.length&&e.every(l),"$pow must be a valid expression that resolves to an array of 2 numbers"),0===e[0]&&e[1]<0&&N("$pow cannot raise 0 to a negative exponent"),Math.pow(e[0],e[1])},$sqrt:function(n,t){var e=Z(n,t,null);return isNaN(e)?NaN:d(e)?null:(r(l(e)&&e>0,"$sqrt must be a valid expression that resolves to a non-negative number."),Math.sqrt(e))},$subtract:function(n,t){var r=Z(n,t,null);return r[0]-r[1]},$trunc:function(n,t){var e=Z(n,t,null);return isNaN(e)?NaN:d(e)?null:(r(l(e)&&e>0,"$trunc must be a valid expression that resolves to a non-negative number."),Math.trunc(e))}},_n={$arrayElemAt:function(n,t){var e=Z(n,t,null);r(s(e)&&2===e.length,"$arrayElemAt expression must resolve to an array of 2 elements"),r(s(e[0]),"First operand to $arrayElemAt must resolve to an array"),r(l(e[1]),"Second operand to $arrayElemAt must resolve to an integer");var u=e[1];return e=e[0],0>u&&Math.abs(u)<=e.length?e[u+e.length]:u>=0&&u<e.length?e[u]:void 0},$concatArrays:function(n,t){var e=Z(n,t,null);return r(s(e)&&2===e.length,"$concatArrays expression must resolve to an array of 2 elements"),e.some(d)?null:e[0].concat(e[1])},$filter:function(n,t){var e=Z(n,t.input,null),u=t.as,i=t.cond;return r(s(e),"'input' expression for $filter must resolve to an array"),e.filter(function(n){var t={};return t["$"+u]=n,Z(t,i,null)===!0})},$indexOfArray:function(n,t){var e=Z(n,t,null);if(d(e))return null;var u=e[0];if(d(u))return null;r(s(u),"First operand for $indexOfArray must resolve to an array.");var i=e[1];if(d(i))return null;var o=e[2]||0,a=e[3]||u.length;return a<u.length&&(u=u.slice(o,a)),u.indexOf(i,o)},$isArray:function(n,t){return s(Z(n,t,null))},$range:function(n,t){for(var r=Z(n,t,null),e=r[0],u=r[1],i=r[2]||1,o=[];u>e&&i>0||e>u&&0>i;)o.push(e),e+=i;return o},$reverseArray:function(n,t){var e=Z(n,t,null);if(d(e))return null;r(s(e),"$reverseArray expression must resolve to an array");for(var u=[],i=e.length-1;i>-1;i--)u.push(e[i]);return u},$reduce:function(n,t){var e=Z(n,t.input,null),u=Z(n,t.initialValue,null),i=t["in"];return d(e)?null:(r(s(e),"'input' expression for $reduce must resolve to an array"),e.reduce(function(n,t){return Z({$value:n,$this:t},i,null)},u))},$size:function(n,t){var r=Z(n,t,null);return s(r)?r.length:void 0},$slice:function(n,t){var r=Z(n,t,null);return nn(r[0],r[1],r[2])},$zip:function(n,t){var e=Z(n,t.inputs,null),u=t.useLongestLength||!1;r(s(e),"'inputs' expression must resolve to an array"),r(o(u),"'useLongestLength' must be a boolean"),s(t.defaults)&&r(b(u),"'useLongestLength' must be set to true to use 'defaults'");var i,a,l=0;for(a=0;a<e.length;a++){if(i=e[a],d(i))return null;r(s(i),"'inputs' expression values must resolve to an array or null"),l=u?Math.max(l,i.length):Math.min(l||i.length,i.length)}var c=[],f=t.defaults||[];for(a=0;l>a;a++)i=e.map(function(n,t){return d(n[a])?f[t]||null:n[a]}),c.push(i);return c}},xn={$and:function(n,t){var r=Z(n,t,null);return b(r)&&r.every(b)},$or:function(n,t){var r=Z(n,t,null);return b(r)&&r.some(b)},$not:function(n,t){return!Z(n,t[0],null)}},On={$cmp:function(n,t){var r=Z(n,t,null);return r[0]>r[1]?1:r[0]<r[1]?-1:0}};k(["$eq","$ne","$gt","$gte","$lt","$lte","$in","$nin"],function(n){On[n]=function(t,r){var e=Z(t,r,null);return mn[n](e[0],e[1])}});var wn={$cond:function(n,t){var r,e,u;s(t)?(3!==t.length&&N("Invalid arguments for $cond operator"),r=t[0],e=t[1],u=t[2]):c(t)&&(r=t["if"],e=t.then,u=t["else"]);var i=Z(n,r,null);return i?Z(n,e,null):Z(n,u,null)},$switch:function(n,t){t.branches||N("Invalid arguments for $switch operator");var r=t.branches.find(function(t){return t["case"]&&t.then||N("Invalid arguments for $switch operator"),Z(n,t["case"],null)});return r?Z(n,r.then,null):t["default"]?Z(n,t["default"],null):void N("Invalid arguments for $switch operator")},$ifNull:function(n,t){r(s(t)&&2===t.length,"Invalid arguments for $ifNull operator");var e=Z(n,t,null);return null===e[0]||void 0===e[0]?e[1]:e[0]}},jn={"%Y":["$year",4],"%m":["$month",2],"%d":["$dayOfMonth",2],"%H":["$hour",2],"%M":["$minute",2],"%S":["$second",2],"%L":["$millisecond",3],"%j":["$dayOfYear",3],"%w":["$dayOfWeek",1],"%U":["$week",2],"%%":"%"},Nn={$dayOfYear:function(n,t){var r=Z(n,t,null);if(h(r)){var e=new Date(r.getFullYear(),0,0),u=r-e,i=864e5;return Math.round(u/i)}},$dayOfMonth:function(n,t){var r=Z(n,t,null);return h(r)?r.getDate():void 0},$dayOfWeek:function(n,t){var r=Z(n,t,null);return h(r)?r.getDay()+1:void 0},$year:function(n,t){var r=Z(n,t,null);return h(r)?r.getFullYear():void 0},$month:function(n,t){var r=Z(n,t,null);return h(r)?r.getMonth()+1:void 0},$week:function(n,t){var r=Z(n,t,null);r=new Date(+r),r.setHours(0,0,0),r.setDate(r.getDate()+4-(r.getDay()||7));var e=new Date(r.getFullYear(),0,1);return Math.floor(((r-e)/864e5+1)/7)},$hour:function(n,t){var r=Z(n,t,null);return h(r)?r.getUTCHours():void 0},$minute:function(n,t){var r=Z(n,t,null);return h(r)?r.getMinutes():void 0},$second:function(n,t){var r=Z(n,t,null);return h(r)?r.getSeconds():void 0},$millisecond:function(n,t){var r=Z(n,t,null);return h(r)?r.getMilliseconds():void 0},$dateToString:function(n,t){for(var r=t.format,e=Z(n,t.date,null),u=r.match(/(%%|%Y|%m|%d|%H|%M|%S|%L|%j|%w|%U)/g),i=0,o=u.length;o>i;i++){var a=jn[u[i]],l=a;if(s(a)){var c=this[a[0]],f=a[1];l=en(c.call(this,n,e),f)}r=r.replace(u[i],l)}return r}},Mn={$literal:function(n,t){return t}},kn={$setEquals:function(n,t){var r=Z(n,t,null),e=C(r[0]),u=C(r[1]);return e.length===u.length&&e.length===E(e,u).length},$setIntersection:function(n,t){var r=Z(n,t,null);return E(r[0],r[1])},$setDifference:function(n,t){var r=Z(n,t,null);return r[0].filter(y.bind(null,r[1]))},$setUnion:function(n,t){var r=Z(n,t,null);return I(r[0],r[1])},$setIsSubset:function(n,t){var r=Z(n,t,null);return E(r[0],r[1]).length===r[0].length},$anyElementTrue:function(n,t){var r=Z(n,t,null)[0];return r.some(b)},$allElementsTrue:function(n,t){var r=Z(n,t,null)[0];return r.every(b)}},An={$concat:function(n,t){var r=Z(n,t,null);return[null,void 0].some(m.bind(null,r))?null:r.join("")},$indexOfBytes:function(n,t){var e=Z(n,t,null);if(d(e[0]))return null;r(a(e[0]),"$indexOfBytes first operand must resolve to a string"),r(a(e[1]),"$indexOfBytes second operand must resolve to a string");var u=e[0],i=e[1],o=e[2],s=e[3];if(r(d(o)||l(o)&&o>=0&&Math.round(o)===o,"$indexOfBytes third operand must resolve to a non-negative integer"),o=o||0,r(d(s)||l(s)&&s>=0&&Math.round(s)===s,"$indexOfBytes fourth operand must resolve to a non-negative integer"),s=s||u.length,o>s)return-1;var c=u.substring(o,s).indexOf(i);return c>-1?c+o:c},$split:function(n,t){var e=Z(n,t,null);return r(a(e[0]),"$split requires an expression that evaluates to a string as a first argument, found: "+w(e[0])),r(a(e[1]),"$split requires an expression that evaluates to a string as a second argument, found: "+w(e[1])),e[0].split(e[1])},$strcasecmp:function(n,t){var r=Z(n,t,null);return r[0]=x(r[0])?"":r[0].toUpperCase(),r[1]=x(r[1])?"":r[1].toUpperCase(),r[0]>r[1]?1:r[0]<r[1]?-1:0},$substr:function(n,t){var r=Z(n,t,null);return a(r[0])?r[1]<0?"":r[2]<0?r[0].substr(r[1]):r[0].substr(r[1],r[2]):""},$toLower:function(n,t){var r=Z(n,t,null);return x(r)?"":r.toLowerCase()},$toUpper:function(n,t){var r=Z(n,t,null);return x(r)?"":r.toUpperCase()}},En={$map:function(n,t){var r=Z(n,t.input,null);s(r)||N("Input expression for $map must resolve to an array");var e=t.as,u=t["in"],i="$"+e,o=n[i];return r.map(function(t){n[i]=t;var r=Z(n,u,null);return $(o)?delete n[i]:n[i]=o,r})},$let:function(n,t){var r=t.vars,e=t["in"],u={},i=M(r);k(i,function(t){var e=Z(n,r[t],null),i="$"+t;u[i]=n[i],n[i]=e});var o=Z(n,e,null);return k(i,function(t){var r="$"+t;$(u[r])?delete n[r]:n[r]=u[r]}),o}},In=Object.assign({},bn,_n,xn,On,wn,Nn,Mn,kn,An,En),qn=n.OP_QUERY="query",Cn=n.OP_GROUP="group",Sn=n.OP_AGGREGATE="aggregate",Pn=n.OP_PIPELINE="pipeline",Tn=n.OP_PROJECTION="projection",Dn={aggregate:In,group:dn,pipeline:gn,projection:$n,query:yn};n.addOperators=function(n,t){var e=t({computeValue:Z,key:U,ops:un,resolve:J});r(j(Dn,n),"Could not identify operator class '"+n+"'");var u=Dn[n];k(e,function(t,e){r(/^\$\w+$/.test(e),"Invalid operator name '"+e+"'"),r(!j(u,e),"Operator "+e+" is already defined for "+n+" operators")});var i={};switch(n){case qn:k(e,function(n,t){i[t]=function(n,r){return function(e,u){return{test:function(i){var a=J(i,e),l=n.call(r,e,a,u);return o(l)?l:l instanceof Query?l.test(i):void N("Invalid return type for '"+t+"'. Must return a Boolean or Mingo.Query")}}}}(n,e)});break;case Tn:k(e,function(n,t){
i[t]=function(n,t){return function(r,e,u){var i=J(r,u);return n.call(t,u,i,e)}}(n,e)});break;default:k(e,function(n,t){i[t]=function(n,t){return function(){var r=on.slice.call(arguments);return n.apply(t,r)}}(n,e)})}Object.assign(Dn[n],i)},n.find=function(t,r,e){return new n.Query(r).find(t,e)},n.remove=function(t,r){return new n.Query(r).remove(t)},n.aggregate=function(t,r){return s(r)||N("Aggregation pipeline must be an array"),new n.Aggregator(r).run(t)},n.CollectionMixin={query:function(t,r){return n.find(this.toJSON(),t,r)},aggregate:function(t){return n.aggregate.call(null,this.toJSON(),t)}}});
//# sourceMappingURL=dist/mingo.min.map